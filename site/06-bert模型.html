
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="05-fasttext%E5%AE%9E%E7%8E%B0.html">
      
      
        <link rel="next" href="07-%E6%A8%A1%E5%9E%8B%E9%87%8F%E5%8C%96.html">
      
      <link rel="icon" href="img/logo.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>3.3 Bert模型使用 - 头条投满分项目V4.0</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.eebd395e.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bert" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="." title="头条投满分项目V4.0" class="md-header__button md-logo" aria-label="头条投满分项目V4.0" data-md-component="logo">
      
  <img src="img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            头条投满分项目V4.0
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3.3 Bert模型使用
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="头条投满分项目V4.0" class="md-nav__button md-logo" aria-label="头条投满分项目V4.0" data-md-component="logo">
      
  <img src="img/logo.png" alt="logo">

    </a>
    头条投满分项目V4.0
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="01-%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF.html" class="md-nav__link">
        1、项目背景
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          2、数据集
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          2、数据集
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02-%E6%95%B0%E6%8D%AE%E9%9B%86%E4%BB%8B%E7%BB%8D.html" class="md-nav__link">
        2.1 数据集介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="03-%E6%95%B0%E6%8D%AE%E9%9B%86%E5%88%86%E6%9E%90.html" class="md-nav__link">
        2.2 数据分析与处理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          3、模型训练与测试
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          3、模型训练与测试
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="04-%E9%9A%8F%E6%9C%BA%E6%A3%AE%E6%9E%97%E6%A1%88%E4%BE%8B.html" class="md-nav__link">
        3.1 随机森林-baseline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="05-fasttext%E5%AE%9E%E7%8E%B0.html" class="md-nav__link">
        3.2 fastext的应用
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          3.3 Bert模型使用
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="06-bert%E6%A8%A1%E5%9E%8B.html" class="md-nav__link md-nav__link--active">
        3.3 Bert模型使用
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1.代码架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2.数据处理
  </a>
  
    <nav class="md-nav" aria-label="2.数据处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    2.1 项目数据集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    2.2 预训练模型相关数据
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3.工具类函数
  </a>
  
    <nav class="md-nav" aria-label="3.工具类函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-build_dataset" class="md-nav__link">
    3.1 工具类函数build_dataset()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-build_iterator" class="md-nav__link">
    3.2 工具函数build_iterator()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33get_time_dif" class="md-nav__link">
    3.3工具类函数get_time_dif()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4bert" class="md-nav__link">
    4.BERT分类模型搭建
  </a>
  
    <nav class="md-nav" aria-label="4.BERT分类模型搭建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-config" class="md-nav__link">
    4.1 实现Config类代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-model" class="md-nav__link">
    4.2 实现Model类代码
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5.编写训练函数,测试函数,评估函数
  </a>
  
    <nav class="md-nav" aria-label="5.编写训练函数,测试函数,评估函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1  编写训练函数.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2 编写验证函数.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53" class="md-nav__link">
    5.3 编写测试函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6 编写训练评估主函数
  </a>
  
    <nav class="md-nav" aria-label="6 编写训练评估主函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1 具体实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#61_1" class="md-nav__link">
    6.1 输出结果
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7.模型预测
  </a>
  
    <nav class="md-nav" aria-label="7.模型预测">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    7.1 推理函数定义
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    7.2 主函数定义
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    8.模型部署
  </a>
  
    <nav class="md-nav" aria-label="8.模型部署">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81" class="md-nav__link">
    8.1 服务端代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82" class="md-nav__link">
    8.2 客户端代码
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9.总结
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          4、模型压缩
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          4、模型压缩
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="07-%E6%A8%A1%E5%9E%8B%E9%87%8F%E5%8C%96.html" class="md-nav__link">
        4.1 模型量化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="08-%E6%A8%A1%E5%9E%8B%E8%92%B8%E9%A6%8F.html" class="md-nav__link">
        4.2 知识蒸馏
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="09-%E6%A8%A1%E5%9E%8B%E8%92%B8%E9%A6%8F%E5%AE%9E%E8%B7%B5.html" class="md-nav__link">
        4.3 知识蒸馏的实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10-%E6%A8%A1%E5%9E%8B%E5%89%AA%E6%9E%9D.html" class="md-nav__link">
        4.4 模型剪枝
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1.代码架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2.数据处理
  </a>
  
    <nav class="md-nav" aria-label="2.数据处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    2.1 项目数据集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    2.2 预训练模型相关数据
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3.工具类函数
  </a>
  
    <nav class="md-nav" aria-label="3.工具类函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-build_dataset" class="md-nav__link">
    3.1 工具类函数build_dataset()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-build_iterator" class="md-nav__link">
    3.2 工具函数build_iterator()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33get_time_dif" class="md-nav__link">
    3.3工具类函数get_time_dif()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4bert" class="md-nav__link">
    4.BERT分类模型搭建
  </a>
  
    <nav class="md-nav" aria-label="4.BERT分类模型搭建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-config" class="md-nav__link">
    4.1 实现Config类代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-model" class="md-nav__link">
    4.2 实现Model类代码
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5.编写训练函数,测试函数,评估函数
  </a>
  
    <nav class="md-nav" aria-label="5.编写训练函数,测试函数,评估函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1  编写训练函数.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2 编写验证函数.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53" class="md-nav__link">
    5.3 编写测试函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6 编写训练评估主函数
  </a>
  
    <nav class="md-nav" aria-label="6 编写训练评估主函数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1 具体实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#61_1" class="md-nav__link">
    6.1 输出结果
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7.模型预测
  </a>
  
    <nav class="md-nav" aria-label="7.模型预测">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    7.1 推理函数定义
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    7.2 主函数定义
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    8.模型部署
  </a>
  
    <nav class="md-nav" aria-label="8.模型部署">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81" class="md-nav__link">
    8.1 服务端代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82" class="md-nav__link">
    8.2 客户端代码
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9.总结
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="bert">BERT模型的实现<a class="headerlink" href="#bert" title="Permanent link">&para;</a></h1>
<p><strong>学习目标：</strong></p>
<p>1.能够构建Bert案例的代码结构</p>
<p>2.能够完成数据集的读取</p>
<p>3.能够完成Bert分类模型的构建</p>
<p>4.能够完成Bert模型的训练与测试</p>
<h2 id="1">1.代码架构<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>代码架构如下所示：</p>
<p><img alt="image-20231116160754975" src="images/image-20231116160754975.png" /></p>
<h2 id="2">2.数据处理<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 项目数据集<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<p>数据集的路径: toutiao/data/data/</p>
<p>项目的数据集包括4个文件, 包含训练集，测试集、验证集数据以及相应的类别信息，与前面介绍的一样。</p>
<h3 id="22">2.2 预训练模型相关数据<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<p>预训练模型相关数据的文件夹路径为data/bert_pretrain/中，预训练模型相关数据共包含3个文件:</p>
<p><img alt="image-20231115173552288" src="images/image-20231115173552288.png" /></p>
<p>1、BERT模型的超参数配置文件</p>
<p>04-bert/data/bert_pretrain/bert_config.json</p>
<hr />
<div class="highlight"><pre><span></span><code><span class="na">{</span>
<span class="w">  </span><span class="na">&quot;attention_probs_dropout_prob&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">0.1,  // 注意力机制的丢弃概率</span>
<span class="w">  </span><span class="na">&quot;directionality&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;bidi&quot;,  // 模型的方向性，这里是双向</span>
<span class="w">  </span><span class="na">&quot;hidden_act&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;gelu&quot;,  // 隐藏层的激活函数，这里是GELU</span>
<span class="w">  </span><span class="na">&quot;hidden_dropout_prob&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">0.1,  // 隐藏层中的丢弃概率</span>
<span class="w">  </span><span class="na">&quot;hidden_size&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">768,  // 隐藏层的神经元个数，对应H</span>
<span class="w">  </span><span class="na">&quot;initializer_range&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">0.02,  // 权重初始化时截断正态分布的标准差的大小</span>
<span class="w">  </span><span class="na">&quot;intermediate_size&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">3072,  // encoder中间隐层神经元个数，对应4H</span>
<span class="w">  </span><span class="na">&quot;max_position_embeddings&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">512,  // 最大的位置编码</span>
<span class="w">  </span><span class="na">&quot;num_attention_heads&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">12,  // 多头注意力头的数量，对应A</span>
<span class="w">  </span><span class="na">&quot;num_hidden_layers&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">12,  // ecoder的重复个数，对应L</span>
<span class="w">  </span><span class="na">&quot;pooler_fc_size&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">768,  // 池化层的全连接层的维度</span>
<span class="w">  </span><span class="na">&quot;pooler_num_attention_heads&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">12,  // 池化层的注意力头的数量</span>
<span class="w">  </span><span class="na">&quot;pooler_num_fc_layers&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">3,  // 池化层的全连接层的数量</span>
<span class="w">  </span><span class="na">&quot;pooler_size_per_head&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">128,  // 池化层中每个注意力头的维度</span>
<span class="w">  </span><span class="na">&quot;pooler_type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;first_token_transform&quot;,  // 池化层的类型，使用第一个标记进行变换</span>
<span class="w">  </span><span class="na">&quot;type_vocab_size&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">2,  // 类型词汇表的大小</span>
<span class="w">  </span><span class="na">&quot;vocab_size&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">21128  // 词汇表的大小</span>
<span class="na">}</span>
</code></pre></div>
<hr />
<p>2、BERT预训练模型权重文件</p>
<p>04-bert/data/bert_pretrain/pytorch_model.bin</p>
<hr />
<p>3、BERT预训练模型词典文件</p>
<p>04-bert/data/bert_pretrain/vocab.txt</p>
<hr />
<div class="highlight"><pre><span></span><code>[PAD]
[unused1]
[unused2]
[unused3]
[unused4]
[unused5]
[unused6]
[unused7]
[unused8]
[unused9]
[unused10]

......
......
......

[unused98]
[unused99]
[UNK]
[CLS]
[SEP]
[MASK]
&lt;S&gt;
&lt;T&gt;
!
......
......
......
</code></pre></div>
<hr />
<hr />
<h2 id="3">3.工具类函数<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<ul>
<li>工具类函数的路径为</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="na">04-bert/src/utils.py</span>
</code></pre></div>
<ul>
<li>所需的工具包如下所示：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
</code></pre></div>
<hr />
<h3 id="31-build_dataset">3.1 工具类函数build_dataset()<a class="headerlink" href="#31-build_dataset" title="Permanent link">&para;</a></h3>
<p>工具类函数build_dataset(), 位于utils.py中的独立函数.该函数的目的是根据配置信息构建用于模型训练的数据集。它通过加载文本文件、分词、添加特殊标记，生成包含词汇索引、标签、序列长度和填充掩码的数据集。最终，函数返回训练集、验证集和测试集，以供模型使用</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    根据配置信息构建模型训练所需的数据集。</span>

<span class="sd">    参数：</span>
<span class="sd">    - config (object): 配置信息对象，包含有关数据集和模型的相关参数。</span>

<span class="sd">    返回：</span>
<span class="sd">    - train, dev, test (tuple): 包含三个元组，分别是训练集、验证集和测试集。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pad_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        加载并处理单个数据集文件。</span>

<span class="sd">        参数：</span>
<span class="sd">        - path (str): 数据集文件路径。</span>
<span class="sd">        - pad_size (int): 填充到的序列长度，默认为32。</span>

<span class="sd">        返回：</span>
<span class="sd">        - contents (list): 包含处理后的数据的列表。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 用于存储处理后的数据的列表</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>  <span class="c1"># 逐行遍历文件内容</span>
                <span class="n">lin</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">lin</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">content</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">lin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 分割每行的内容和标签</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>  <span class="c1"># 使用分词器对内容进行分词</span>
                <span class="n">token</span> <span class="o">=</span> <span class="p">[</span><span class="n">CLS</span><span class="p">]</span> <span class="o">+</span> <span class="n">token</span>  <span class="c1"># 在分词结果前加入[CLS]标记</span>
                <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>  <span class="c1"># 计算序列长度</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 用于存储填充掩码</span>

                <span class="n">token_ids</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_tokens_to_ids</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>  <span class="c1"># 将分词结果转换为词汇索引</span>

                <span class="k">if</span> <span class="n">pad_size</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pad_size</span><span class="p">:</span>  <span class="c1"># 如果序列长度小于设定的填充长度</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pad_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>  <span class="c1"># 创建填充掩码</span>
                        <span class="n">token_ids</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pad_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>  <span class="c1"># 对词汇索引列表进行填充</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_size</span>  <span class="c1"># 如果序列长度大于等于填充长度，填充掩码为全1</span>
                        <span class="n">token_ids</span> <span class="o">=</span> <span class="n">token_ids</span><span class="p">[:</span><span class="n">pad_size</span><span class="p">]</span>  <span class="c1"># 对词汇索引列表进行截断</span>
                        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">pad_size</span>  <span class="c1"># 更新序列长度为填充长度</span>
                <span class="c1"># 将处理后的数据添加到contents列表</span>
                <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">),</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">contents</span>

    <span class="c1"># 使用load_dataset函数加载训练集、验证集和测试集</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_path</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">pad_size</span><span class="p">)</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dev_path</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">pad_size</span><span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">test_path</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">pad_size</span><span class="p">)</span>

    <span class="c1"># 返回三个元组，分别是训练集、验证集和测试集</span>
    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">test</span>
</code></pre></div>
<hr />
<h3 id="32-build_iterator">3.2 工具函数build_iterator()<a class="headerlink" href="#32-build_iterator" title="Permanent link">&para;</a></h3>
<p>包括数据迭代器的类class DatasetIterater()和工具函数build_iterator()，位于utils.py中的独立函数和类. </p>
<ul>
<li><strong><code>DatasetIterater</code> 类：</strong></li>
<li><code>__init__</code>：接收批次数据、批次大小、设备类型和模型名称，设置相关属性。</li>
<li><code>_to_tensor</code> 函数：将批次数据转换为 PyTorch 的 Tensor 格式。</li>
<li><code>__next__</code> 函数：获取下一个批次的样本，处理不规则批次和索引溢出。</li>
<li><code>__iter__</code> 函数：返回迭代器对象本身。</li>
<li><code>__len__</code> 函数：获取迭代器的长度。</li>
<li><strong><code>build_iterator</code> 函数：</strong></li>
<li>根据配置信息和给定的数据集构建数据集迭代器对象。</li>
<li>返回数据集迭代器。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DatasetIterater</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        数据集迭代器的初始化函数。</span>
<span class="sd">        参数：</span>
<span class="sd">        - batches (list): 包含样本的列表。</span>
<span class="sd">        - batch_size (int): 每个批次的大小。</span>
<span class="sd">        - device (str): 数据加载到的设备（CPU或GPU）。</span>
<span class="sd">        - model_name (str): 使用的模型名称。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="c1"># 每个批次的大小</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span> <span class="c1"># 包含样本的列表</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span> <span class="c1"># 使用的模型名称</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span> <span class="c1"># 批次的数量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residue</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 记录batch数量是否为整数</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residue</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 当前批次的索引</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="c1"># 数据加载到的设备（CPU或GPU）</span>

    <span class="k">def</span> <span class="nf">_to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datas</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        将样本数据转换为Tensor。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># pad前的长度(超过pad_size的设为pad_size)</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># 若为BERT模型，返回(x, seq_len, mask), y；</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;bert&quot;</span> <span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">_</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">mask</span><span class="p">),</span> <span class="n">y</span>
        <span class="c1"># 若为TextCNN模型，返回(x, seq_len), y</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;textCNN&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">),</span> <span class="n">y</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取下一个批次的样本。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_tensor</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">batches</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_tensor</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">batches</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回迭代器对象本身。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取迭代器的长度。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span>

<span class="k">def</span> <span class="nf">build_iterator</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    根据配置信息构建数据集迭代器。</span>
<span class="sd">    返回：</span>
<span class="sd">    - 数据集迭代器对象。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="n">DatasetIterater</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">iter</span>
</code></pre></div>
<hr />
<h3 id="33get_time_dif">3.3工具类函数get_time_dif()<a class="headerlink" href="#33get_time_dif" title="Permanent link">&para;</a></h3>
<p>get_time_dif()函数位于utils.py中的独立函数，该函数接受一个开始时间戳作为参数，计算当前时间与开始时间的差值，并将差值转换为 <code>timedelta</code> 对象表示已使用的时间。这种计算时间差的方法通常用于测量程序运行的时间。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_time_dif</span><span class="p">(</span><span class="n">start_time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    计算已使用的时间差。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 获取当前时间</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># 计算时间差</span>
    <span class="n">time_dif</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="c1"># 将时间差转换为整数秒，并返回时间差对象</span>
    <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time_dif</span><span class="p">))</span>
</code></pre></div>
<h2 id="4bert">4.BERT分类模型搭建<a class="headerlink" href="#4bert" title="Permanent link">&para;</a></h2>
<p>接下来实现一个基于BERT的文本分类模型，并包含了相关的配置信息。该部分代码在：</p>
<div class="highlight"><pre><span></span><code><span class="na">04-bert/src/models/bert.py</span>
</code></pre></div>
<p>主要内容包含：</p>
<p>配置类 <code>Config</code>：和模型类 <code>Model</code>：</p>
<p>首先**导入工具包**：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">BertModel</span><span class="p">,</span> <span class="n">BertTokenizer</span><span class="p">,</span> <span class="n">BertConfig</span>
</code></pre></div>
<h3 id="41-config">4.1 实现Config类代码<a class="headerlink" href="#41-config" title="Permanent link">&para;</a></h3>
<p>配置类 <code>Config</code>中主要包含以下内容：</p>
<ul>
<li><code>Config</code> 类包含了用于模型训练和数据处理的各种参数。</li>
<li>定义了模型名称、数据集路径、训练集、验证集、测试集文件路径、类别名单等信息。</li>
<li>包含模型训练结果和量化模型存储结果的路径。</li>
<li>配置了训练设备（GPU或CPU）、类别数、epoch数、mini-batch大小、句子长度等。</li>
<li>BERT预训练模型的路径、分词器、BERT模型配置、隐藏层大小等。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        配置类，包含模型和训练所需的各种参数。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;bert&quot;</span> <span class="c1"># 模型名称</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="s2">&quot;/Users/mac/Desktop/投满分项目/03-code/04-bert/data/data1/&quot;</span> <span class="c1">#数据集的根路径</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;train.txt&quot;</span>  <span class="c1"># 训练集</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;dev.txt&quot;</span>  <span class="c1"># 验证集</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;test.txt&quot;</span>  <span class="c1"># 测试集</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;class.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>  <span class="c1"># 类别名单</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="s2">&quot;/Users/mac/Desktop/投满分项目/03-code/04-bert/src/saved_dic&quot;</span> <span class="c1">#模型训练结果保存路径</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;.pt&quot;</span>  <span class="c1"># 模型训练结果</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_path2</span> <span class="o">=</span> <span class="s2">&quot;/Users/mac/Desktop/投满分项目/03-code/04-bert/src/saved_dic1&quot;</span> <span class="c1"># 量化模型存储结果路径</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path2</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_path2</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_quantized.pt&quot;</span>  <span class="c1"># 量化模型存储结果</span>

        <span class="c1"># 模型训练+预测的时候, 放开下一行代码, 在GPU上运行.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>  <span class="c1"># 训练设备，如果GPU可用，则为cuda，否则为cpu</span>
        <span class="c1"># 模型量化的时候, 放开下一行代码, 在CPU上运行.</span>
        <span class="c1"># self.device = &#39;cpu&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_list</span><span class="p">)</span>  <span class="c1"># 类别数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># epoch数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>  <span class="c1"># mini-batch大小</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_size</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># 每句话处理成的长度(短填长切)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">5e-5</span>  <span class="c1"># 学习率</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_path</span> <span class="o">=</span> <span class="s2">&quot;/Users/mac/Desktop/投满分项目/03-code/04-bert/data/bert_pretrain&quot;</span> <span class="c1"># 预训练BERT模型的路径</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BertTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_path</span><span class="p">)</span> <span class="c1"># BERT模型的分词器</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert_config</span> <span class="o">=</span> <span class="n">BertConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bert_path</span> <span class="o">+</span> <span class="s1">&#39;/bert_config.json&#39;</span><span class="p">)</span> <span class="c1"># BERT模型的配置</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">768</span> <span class="c1"># BERT模型的隐藏层大小</span>
</code></pre></div>
<h3 id="42-model">4.2 实现Model类代码<a class="headerlink" href="#42-model" title="Permanent link">&para;</a></h3>
<p>**模型类 <code>Model</code>**主要实现以下内容：</p>
<ul>
<li><code>Model</code> 类继承自 <code>nn.Module</code>，实现了一个基于BERT的文本分类模型。</li>
<li>在初始化方法中，加载预训练的BERT模型和配置，并定义了一个全连接层用于文本分类。</li>
<li>在前向传播方法中，通过BERT模型获取句子的表示，然后通过全连接层进行分类</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># 预训练BERT模型</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bert</span> <span class="o">=</span> <span class="n">BertModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">bert_path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bert_config</span><span class="p">)</span>
        <span class="c1"># 全连接层，用于文本分类</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">num_classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># x: 模型输入，包含句子、句子长度和填充掩码。</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 输入的句子</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 对padding部分进行mask，和句子一个size，padding部分用0表示，如：[1, 1, 1, 1, 0, 0]</span>
        <span class="c1"># _是占位符，接收模型的所有输出，而 pooled 是池化的结果,将整个句子的信息压缩成一个固定长度的向量</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">pooled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># 模型输出，用于文本分类</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">pooled</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
<p>bert.py文件提供了一个简单而灵活的BERT文本分类模型，通过配置类可以方便地调整模型参数，适应不同的文本分类任务，通过model类构建整个网络结构。</p>
<h2 id="5">5.编写训练函数,测试函数,评估函数<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>这3个函数共同编写在一个代码文件中:</p>
<div class="highlight"><pre><span></span><code><span class="mi">04</span><span class="o">-</span><span class="n">bert</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">train_eval</span><span class="o">.</span><span class="n">py</span>
</code></pre></div>
<p>首先导入相关工具包，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_time_dif</span>
<span class="kn">from</span> <span class="nn">transformers.optimization</span> <span class="kn">import</span> <span class="n">AdamW</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">logging</span>
</code></pre></div>
<hr />
<h3 id="51">5.1  编写训练函数.<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<p>训练函数实现了模型的训练过程，使用了交叉熵损失函数和AdamW优化器。具体包括以下内容：</p>
<ol>
<li><strong>优化器设置：</strong> 使用AdamW优化器，并设置了参数的权重衰减。</li>
<li><strong>训练循环：</strong> 遍历每个epoch和每个batch，进行前向传播、计算损失、反向传播、参数更新。</li>
<li><strong>评估：</strong> 每100个batch输出在训练集和验证集上的效果，包括训练损失、训练准确率、验证损失、验证准确率等。</li>
<li><strong>保存模型：</strong> 若验证集上的损失更低，保存当前模型的参数。</li>
<li><strong>时间计算：</strong> 计算训练的总时间。</li>
</ol>
<p>具体实现如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    定义损失函数，使用交叉熵损失。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">dev_iter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    模型训练函数。</span>
<span class="sd">    参数：</span>
<span class="sd">    - config: 配置信息对象。</span>
<span class="sd">    - model: 待训练的模型。</span>
<span class="sd">    - train_iter: 训练集的迭代器。</span>
<span class="sd">    - dev_iter: 验证集的迭代器。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 记录开始训练的时间</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># 参数优化器设置</span>
    <span class="n">param_optimizer</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">())</span>
    <span class="n">no_decay</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">,</span> <span class="s2">&quot;LayerNorm.bias&quot;</span><span class="p">,</span> <span class="s2">&quot;LayerNorm.weight&quot;</span><span class="p">]</span>
    <span class="n">optimizer_grouped_parameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_optimizer</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span>
         <span class="s2">&quot;weight_decay&quot;</span><span class="p">:</span> <span class="mf">0.01</span>
         <span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_optimizer</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span>
         <span class="s2">&quot;weight_decay&quot;</span><span class="p">:</span> <span class="mf">0.0</span>
         <span class="p">}]</span>
    <span class="c1"># 设置优化器</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">(</span><span class="n">optimizer_grouped_parameters</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
    <span class="n">dev_best_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
    <span class="c1"># 将模型设置为训练模型师</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="c1"># 遍历每个轮次</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">total_batch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch [</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">))</span>
        <span class="c1"># 遍历每个批次</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">trains</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">train_iter</span><span class="p">)):</span>
            <span class="c1"># 模型前向传播</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">trains</span><span class="p">)</span>
            <span class="c1"># 梯度清零</span>
            <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># 计算损失</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="c1"># 反向传播</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># 参数更新</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="c1"># 每100个batch输出在训练集和验证集上的效果</span>
            <span class="k">if</span> <span class="n">total_batch</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">total_batch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">true</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="n">predic</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="n">train_acc</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">predic</span><span class="p">)</span>
                <span class="c1"># 评估验证集效果</span>
                <span class="n">dev_acc</span><span class="p">,</span> <span class="n">dev_loss</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dev_iter</span><span class="p">)</span>
                <span class="c1"># 若验证集损失更低，保存模型参数</span>
                <span class="k">if</span> <span class="n">dev_loss</span> <span class="o">&lt;</span> <span class="n">dev_best_loss</span><span class="p">:</span>
                    <span class="n">dev_best_loss</span> <span class="o">=</span> <span class="n">dev_loss</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">config</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
                    <span class="n">improve</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">improve</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="c1"># 计算时间差</span>
                <span class="n">time_dif</span> <span class="o">=</span> <span class="n">get_time_dif</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
                <span class="c1"># 输出训练和验证集上的效果</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Iter: </span><span class="si">{0:&gt;6}</span><span class="s2">,  Train Loss: </span><span class="si">{1:&gt;5.2}</span><span class="s2">,  Train Acc: </span><span class="si">{2:&gt;6.2%}</span><span class="s2">,  Val Loss: </span><span class="si">{3:&gt;5.2}</span><span class="s2">,  Val Acc: </span><span class="si">{4:&gt;6.2%}</span><span class="s2">,  Time: </span><span class="si">{5}</span><span class="s2"> </span><span class="si">{6}</span><span class="s2">&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_batch</span><span class="p">,</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">train_acc</span><span class="p">,</span> <span class="n">dev_loss</span><span class="p">,</span> <span class="n">dev_acc</span><span class="p">,</span> <span class="n">time_dif</span><span class="p">,</span> <span class="n">improve</span><span class="p">))</span>
                <span class="c1"># 评估完成后将模型置于训练模式, 更新参数</span>
                <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="c1"># 每个batch结束后累加计数</span>
            <span class="n">total_batch</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
<hr />
<h3 id="52">5.2 编写验证函数.<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<p>模型验证函数 <code>evaluate</code>，用于在验证集或测试集上评估模型的性能。主要功能包括：</p>
<ol>
<li><strong>损失计算：</strong> 通过循环遍历数据集，计算模型在每个样本上的损失，并累加得到总损失。</li>
<li><strong>预测结果记录：</strong> 记录模型对每个样本的预测结果和真实标签。</li>
<li><strong>准确率计算：</strong> 根据记录的预测结果和真实标签计算模型的准确率。</li>
<li><strong>测试集评估：</strong> 如果是测试集评估，额外计算分类报告和混淆矩阵。</li>
</ol>
<p>该函数的目的是提供一种简便的方式，以便在训练过程中监控模型的性能，并在需要时保存性能较好的模型参数。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_iter</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    模型评估函数。</span>
<span class="sd">    参数：</span>
<span class="sd">    - config: 配置信息对象。</span>
<span class="sd">    - model: 待评估的模型。</span>
<span class="sd">    - data_iter: 数据迭代器。</span>
<span class="sd">    - test: 是否为测试集评估。</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 采用量化模型进行推理时需要关闭</span>
    <span class="c1"># model.eval()</span>

    <span class="n">loss_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># 预测结果</span>
    <span class="n">predict_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># label信息</span>
    <span class="n">labels_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># 不进行梯度计算</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="c1"># 遍历数据集</span>
        <span class="k">for</span> <span class="n">texts</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">data_iter</span><span class="p">:</span>
            <span class="c1"># 将数据送入网络中</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
            <span class="c1"># 损失函数</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="c1"># 损失和</span>
            <span class="n">loss_total</span> <span class="o">+=</span> <span class="n">loss</span>
            <span class="c1"># 获取label信息</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="c1"># 获取预测结果</span>
            <span class="n">predic</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">labels_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels_all</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="n">predict_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predict_all</span><span class="p">,</span> <span class="n">predic</span><span class="p">)</span>
    <span class="c1"># 计算准确率</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">labels_all</span><span class="p">,</span> <span class="n">predict_all</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
        <span class="c1"># 如果是测试集评估，计算分类报告和混淆矩阵</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">classification_report</span><span class="p">(</span><span class="n">labels_all</span><span class="p">,</span> <span class="n">predict_all</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">class_list</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">confusion</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">labels_all</span><span class="p">,</span> <span class="n">predict_all</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">loss_total</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_iter</span><span class="p">),</span> <span class="n">report</span><span class="p">,</span> <span class="n">confusion</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 如果是验证集评估，仅返回准确率和平均损失</span>
        <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">loss_total</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_iter</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="53">5.3 编写测试函数<a class="headerlink" href="#53" title="Permanent link">&para;</a></h3>
<p>测试<code>test</code> 函数用于在测试集上进行最终的模型测试。它调用了之前定义的 <code>evaluate</code> 函数，然后输出测试集上的损失、准确率、分类报告和混淆矩阵等信息。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    模型测试函数，用于在测试集上进行最终的模型测试。</span>
<span class="sd">    参数：</span>
<span class="sd">    - config: 配置信息对象。</span>
<span class="sd">    - model: 待测试的模型。</span>
<span class="sd">    - test_iter: 测试集的数据迭代器。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 采用量化模型进行推理时需要关闭</span>
    <span class="c1"># model.eval()</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># 调用验证函数计算评估指标</span>
    <span class="n">test_acc</span><span class="p">,</span> <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_report</span><span class="p">,</span> <span class="n">test_confusion</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 打印测试结果信息:输出测试集上的损失、准确率、分类报告和混淆矩阵等信息</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Test Loss: </span><span class="si">{0:&gt;5.2}</span><span class="s2">,  Test Acc: </span><span class="si">{1:&gt;6.2%}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_loss</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Precision, Recall and F1-Score...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">test_report</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Confusion Matrix...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">test_confusion</span><span class="p">)</span>
    <span class="n">time_dif</span> <span class="o">=</span> <span class="n">get_time_dif</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time usage:&quot;</span><span class="p">,</span> <span class="n">time_dif</span><span class="p">)</span>
</code></pre></div>
<h2 id="6">6 编写训练评估主函数<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>我们实现一个简单的入口脚本，用于指定模型类型，然后加载对应模型的配置和模型定义，构建数据集和数据迭代器，最后进行模型的训练和测试。</p>
<p>该代码在：</p>
<div class="highlight"><pre><span></span><code>04-bert/src/run.py
</code></pre></div>
<h3 id="61">6.1 具体实现<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<p>代码实现如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">train_eval</span> <span class="kn">import</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">build_dataset</span><span class="p">,</span> <span class="n">build_iterator</span><span class="p">,</span> <span class="n">get_time_dif</span>

<span class="c1"># 命令行参数解析</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Chinese Text Classification&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;bert&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;choose a model: bert&quot;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;bert&quot;</span><span class="p">:</span>
        <span class="c1"># 导入对应模型的配置和模型定义</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;bert&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;models.&quot;</span> <span class="o">+</span> <span class="n">model_name</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>

        <span class="c1"># 设置随机种子，保证实验的可重复性</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 保证每次结果一样</span>

        <span class="c1"># 构建训练、验证、测试数据集和数据迭代器</span>
        <span class="n">train_data</span><span class="p">,</span> <span class="n">dev_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">build_dataset</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">train_iter</span> <span class="o">=</span> <span class="n">build_iterator</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">dev_iter</span> <span class="o">=</span> <span class="n">build_iterator</span><span class="p">(</span><span class="n">dev_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">test_iter</span> <span class="o">=</span> <span class="n">build_iterator</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="c1"># 创建模型实例并移至指定设备</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># 训练模型</span>
        <span class="n">train</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">dev_iter</span><span class="p">)</span>
        <span class="c1"># 在测试集上测试模型性能</span>
        <span class="n">test</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
</code></pre></div>
<h3 id="61_1">6.1 输出结果<a class="headerlink" href="#61_1" title="Permanent link">&para;</a></h3>
<p>执行上述函数，运行结果如下：</p>
<div class="highlight"><pre><span></span><code>Loading data for Bert Model...
180000it [00:37, 4820.80it/s]
10000it [00:02, 4954.00it/s]
10000it [00:02, 4952.50it/s]
Epoch [1/3]
 14%|█████████▉                                                            | 200/1407 [02:06&lt;13:26,  1.50it/s]Iter:    200,  Train Loss:   0.3,  Train Acc: 91.41%,  Val Loss:  0.29,  Val Acc: 90.86%,  Time: 0:02:26 *
 28%|███████████████████▉                                                  | 400/1407 [04:44&lt;11:46,  1.43it/s]Iter:    400,  Train Loss:  0.34,  Train Acc: 90.62%,  Val Loss:  0.26,  Val Acc: 92.10%,  Time: 0:05:07 *
 43%|█████████████████████████████▊                                        | 600/1407 [07:26&lt;09:25,  1.43it/s]Iter:    600,  Train Loss:  0.29,  Train Acc: 91.41%,  Val Loss:  0.25,  Val Acc: 92.10%,  Time: 0:07:49 *
 57%|███████████████████████████████████████▊                              | 800/1407 [10:08&lt;07:06,  1.42it/s]Iter:    800,  Train Loss:  0.15,  Train Acc: 94.53%,  Val Loss:  0.22,  Val Acc: 92.85%,  Time: 0:10:31 *
 71%|█████████████████████████████████████████████████                    | 1000/1407 [12:50&lt;04:43,  1.44it/s]Iter:   1000,  Train Loss:  0.17,  Train Acc: 94.53%,  Val Loss:  0.22,  Val Acc: 93.00%,  Time: 0:13:10 
No optimization for a long time, auto-stopping...
Test Loss:   0.2,  Test Acc: 93.64%
Precision, Recall and F1-Score...
               precision    recall  f1-score   support

      finance     0.9246    0.9320    0.9283      1000
       realty     0.9484    0.9370    0.9427      1000
       stocks     0.8787    0.8980    0.8882      1000
    education     0.9511    0.9730    0.9619      1000
      science     0.9236    0.8950    0.9091      1000
      society     0.9430    0.9270    0.9349      1000
     politics     0.9267    0.9100    0.9183      1000
       sports     0.9780    0.9780    0.9780      1000
         game     0.9514    0.9600    0.9557      1000
entertainment     0.9390    0.9540    0.9464      1000

     accuracy                         0.9364     10000
    macro avg     0.9365    0.9364    0.9364     10000
 weighted avg     0.9365    0.9364    0.9364     10000

Confusion Matrix...
[[932  10  37   2   5   5   7   1   1   0]
 [ 13 937  11   2   4  10   5   5   5   8]
 [ 49  12 898   1  19   1  15   0   2   3]
 [  1   1   0 973   0   8   7   0   1   9]
 [  4   4  28   7 895  10  12   2  27  11]
 [  2   8   4  16   5 927  18   1   5  14]
 [  3   8  34  12   9  19 910   0   0   5]
 [  2   3   2   1   1   1   4 978   1   7]
 [  0   2   4   0  24   1   3   1 960   5]
 [  2   3   4   9   7   1   1  12   7 954]]
Time usage: 0:00:19
 71%|█████████████████████████████████████████████████                    | 1000/1407 [13:29&lt;05:29,  1.24it/s]
</code></pre></div>
<hr />
<p>结论: BERT模型在测试集上的表现是Test Acc: 93.64% , 对比于第一章的fasttext模型最好的表现91.93%, 有了1.71%的提升, 可以说是显著性提升了!</p>
<p>并且会保存相应训练权重：</p>
<p><img alt="image-20231116141554734" src="images/image-20231116141554734.png" /></p>
<h2 id="7">7.模型预测<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>接下来使用上一部分训练好的模型权重进行预测，实现了一个推理过程，该部分代码在：</p>
<div class="highlight"><pre><span></span><code><span class="na">04-bert/src/predict.py</span>
</code></pre></div>
<p>首先导入工具包：</p>
<div class="highlight"><pre><span></span><code>import torch
from importlib import import_module
import numpy as np
</code></pre></div>
<h3 id="71">7.1 推理函数定义<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<p>推理函数来完成对新样本的预测，接下来定义：</p>
<ol>
<li><strong>定义特殊符号和类别映射：</strong> 定义了用于填充的特殊符号（[UNK], [PAD], [CLS]）以及类别ID到类别名的映射。</li>
<li><strong>编写推理函数 <code>inference</code>：</strong> 定义了一个用于模型推理的函数，该函数接受一个模型、模型配置、待分析的文本，返回模型对文本的预测结果。</li>
</ol>
<p>具体实现如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 定义特殊的符号和类别映射</span>
<span class="n">CLS</span> <span class="o">=</span>  <span class="s2">&quot;[CLS]&quot;</span>
<span class="n">id_to_name</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;finance&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;realty&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;science&#39;</span><span class="p">,</span>
              <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;society&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;politics&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;sports&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;entertainment&#39;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">input_text</span><span class="p">,</span> <span class="n">pad_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    模型推理函数，用于对输入文本进行情感分析的推理。</span>
<span class="sd">    参数：</span>
<span class="sd">    - model: 已加载的情感分析模型。</span>
<span class="sd">    - config: 模型配置信息。</span>
<span class="sd">    - input_text: 待分析的文本。</span>
<span class="sd">    - pad_size: 指定文本填充的长度。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 对输入文本进行分词和预处理</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">CLS</span><span class="p">]</span> <span class="o">+</span> <span class="n">content</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">token_ids</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_tokens_to_ids</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="c1"># 填充或截断文本至指定长度</span>
    <span class="k">if</span> <span class="n">seq_len</span> <span class="o">&lt;</span> <span class="n">pad_size</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pad_size</span> <span class="o">-</span> <span class="n">seq_len</span><span class="p">)</span>
        <span class="n">token_ids</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pad_size</span> <span class="o">-</span> <span class="n">seq_len</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_size</span>
        <span class="n">token_ids</span> <span class="o">=</span> <span class="n">token_ids</span><span class="p">[:</span><span class="n">pad_size</span><span class="p">]</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">pad_size</span>
    <span class="c1"># 将处理后的文本转换为PyTorch Tensor</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">seq_len</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># 增加一维，表示batch_size为1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">seq_len</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="c1"># 模型推理</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># 获取模型预测结果id</span>
    <span class="n">predict_result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">predict_result</span>
</code></pre></div>
<h3 id="72">7.2 主函数定义<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<p>在主程序中加载了预训练的BERT模型和相关配置，创建了模型实例，并对指定文本进行分析推理。最后输出了模型对文本的预测结果。具体实现如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># 加载BERT模型配置和模型</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;bert&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;models.&#39;</span> <span class="o">+</span> <span class="n">model_name</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
    <span class="c1"># 设置随机种子，保证实验的可重复性</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># 创建并加载BERT模型</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
    <span class="c1"># 待分析的文本</span>
    <span class="n">input_text</span> <span class="o">=</span> <span class="s1">&#39;日本地震：金吉列关注在日学子系列报道&#39;</span>
    <span class="c1"># 进行模型推理</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">input_text</span><span class="p">)</span>
    <span class="c1"># 获取类别名</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">id_to_name</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p>执行上述代码输出的结果为：</p>
<div class="highlight"><pre><span></span><code><span class="na">education</span>
</code></pre></div>
<h2 id="8">8.模型部署<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>将训练好的机器学习模型应用到实际生产环境中，将模型以服务的形式提供，允许其他系统通过 API 调用，实现模型的可复用性。</p>
<h3 id="81">8.1 服务端代码<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<p>利用Flask应用搭建一个Web服务，用来接收客户端通过POST请求发送的文本数据，然后使用预训练的BERT模型进行推理，最后返回预测结果。该部分代码在：</p>
<div class="highlight"><pre><span></span><code><span class="na">04-bert/src/app.py</span>
</code></pre></div>
<p>首先导入相应的工具包：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</code></pre></div>
<p>接下来加载了预训练的BERT情感分析模型和相关配置，并定义推理函数，与之前提到的推理函数相同，用于对输入文本进行分类，与上述模型预测时类似：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 定义BERT特殊符号和类别映射</span>
<span class="n">CLS</span> <span class="o">=</span> <span class="s1">&#39;[CLS]&#39;</span>
<span class="n">id_to_name</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;finance&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;realty&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;science&#39;</span><span class="p">,</span>
              <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;society&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;politics&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;sports&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;entertainment&#39;</span><span class="p">}</span>

<span class="c1"># 加载BERT情感分析模型和相关配置</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;bert&#39;</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;models.&#39;</span> <span class="o">+</span> <span class="n">model_name</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>

<span class="c1"># 推理函数，用于对输入文本进行分类分析,与模型预测部分是一样的</span>
<span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">input_text</span><span class="p">,</span> <span class="n">pad_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="c1"># 对输入文本进行分词和预处理</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">CLS</span><span class="p">]</span> <span class="o">+</span> <span class="n">content</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">token_ids</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_tokens_to_ids</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="c1"># 填充或截断文本到指定长度</span>
    <span class="k">if</span> <span class="n">seq_len</span> <span class="o">&lt;</span> <span class="n">pad_size</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pad_size</span> <span class="o">-</span> <span class="n">seq_len</span><span class="p">)</span>
        <span class="n">token_ids</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pad_size</span> <span class="o">-</span> <span class="n">seq_len</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_size</span>
        <span class="n">token_ids</span> <span class="o">=</span> <span class="n">token_ids</span><span class="p">[:</span><span class="n">pad_size</span><span class="p">]</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">pad_size</span>
    <span class="c1"># 将处理后的文本转换为Tensor形式</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">seq_len</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># 增加一个维度</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">seq_len</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># 获取预测结果并返回</span>
    <span class="n">predict_result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">predict_result</span> <span class="o">=</span> <span class="n">predict_result</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">predict_result</span> <span class="o">=</span> <span class="n">id_to_name</span><span class="p">[</span><span class="n">predict_result</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">predict_result</span>
</code></pre></div>
<p>最后使用Flask创建一个Web应用。并定义一个路由，接收POST请求，从请求中获取用户ID和文本数据，然后调用推理函数获取预测结果，并将结果作为响应返回给客户端。如果该脚本作为主程序运行，则启动Flask应用，具体实现如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建Flask应用</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># 定义路由，接收POST请求并进行推理</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/v1/main_server/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">main_server</span><span class="p">():</span>
    <span class="c1"># 从POST请求中获取用户ID和文本数据</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
    <span class="c1"># 调用推理函数获取预测结果</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="c1"># 如果脚本作为主程序运行，则启动Flask应用</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>通过这个Web服务，客户端可以通过向服务器发送文本数据的POST请求，获取BERT模型对文本的预测结果，我们执行这个文件，输出结果如下所示：</p>
<div class="highlight"><pre><span></span><code>* Serving Flask app &#39;app&#39;
 * Debug mode: off
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on http://127.0.0.1:5000
Press CTRL+C to quit
</code></pre></div>
<h3 id="82">8.2 客户端代码<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<p>客户端代码向Flask应用发送HTTP POST请求，传递文本数据，然后获取Flask应用返回的文本类别预测结果，并打印出预测结果和单条样本的处理耗时。该部分代码在：</p>
<div class="highlight"><pre><span></span><code><span class="na">04-bert/src/demo.py</span>
</code></pre></div>
<p>具体实现如下：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># 定义请求url和传入的data</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://127.0.0.1:5000/v1/main_server/&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;uid&quot;</span><span class="p">:</span> <span class="s2">&quot;AI-12-001&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;日本地震：金吉列关注在日学子系列报道&quot;</span><span class="p">}</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># 向服务发送post请求</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">cost_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="c1"># 打印返回的结果</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;文本类别: &#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;单条样本耗时: &#39;</span><span class="p">,</span> <span class="n">cost_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">)</span>
</code></pre></div>
<p>执行上述代码，预测结果为：</p>
<div class="highlight"><pre><span></span><code><span class="n">文本类别</span><span class="p">:</span>  <span class="n">education</span>
<span class="n">单条样本耗时</span><span class="p">:</span>  <span class="mf">181.6861629486084</span> <span class="n">ms</span>
</code></pre></div>
<h2 id="9">9.总结<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>实现了若干工具函数, 包括数据的获取等内容.</p>
</li>
<li>
<p>实现了基于BERT实现投满分分类的模型, 并完成了训练和测试评估.</p>
</li>
<li>实现了模型预测和部署的内容</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="js/extra.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        
      
    
  </body>
</html>